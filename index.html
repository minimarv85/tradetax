<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeTax - UK Sole Trader Finance</title>
    <!-- Tesseract.js for Receipt OCR (FREE) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { 
            /* Primary Brand Colors */
            --primary: #1A365D;  /* Deep Navy */
            --primary-light: #2C5282;
            --primary-dark: #0F2744;
            
            /* Accent Colors */
            --success: #10B981;  /* Financial Green */
            --success-light: #34D399;
            --danger: #DC2626;   /* Alert Red */
            --cta: #F97316;       /* Warm Coral */
            
            /* Backgrounds - Light Mode Default */
            --bg: #F9FAFB;        /* Cool Gray 50 */
            --card: #FFFFFF;      /* Crisp White */
            --bg-alt: #F3F4F6;    /* Slight contrast */
            --bg-dark: #1F2937;   /* Dark backgrounds */
            
            /* Text */
            --text: #111827;       /* Cool Gray 900 */
            --text-secondary: #4B5563; /* Cool Gray 600 */
            --text-muted: #9CA3AF;
            --text-inverse: #FFFFFF;
            
            /* Borders & Dividers */
            --border: #E5E7EB;     /* Cool Gray 200 */
            --border-dark: #D1D5DB;
            
            /* Shadows */
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #1A365D 0%, #2C5282 100%);
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --bg: #111827;         /* Cool Gray 900 */
            --card: #1F2937;       /* Cool Gray 800 */
            --bg-alt: #374151;     /* Cool Gray 700 */
            --bg-dark: #030712;    /* Gray 950 */
            --text: #FFFFFF;       /* White for visibility */
            --text-secondary: #E5E7EB; /* Cool Gray 200 */
            --text-muted: #9CA3AF; /* Cool Gray 400 */
            --border: #4B5563;     /* Cool Gray 600 */
            --border-dark: #6B7280;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            
            /* Dark Mode Primary - Yellow instead of Navy */
            --primary: #FACC15;    /* Yellow-400 */
            --primary-light: #FDE047; /* Lighter yellow */
            --primary-dark: #CA8A04; /* Darker yellow */
        }
        
        /* Dark Mode Hover States */
        [data-theme="dark"] .feature-btn:hover { background: #374151; border-color: #60A5FA; color: #FFFFFF; }
        [data-theme="dark"] .nav-item.active { background: #374151; color: #60A5FA; }
        [data-theme="dark"] .segmented-tab.active { background: #374151; color: #60A5FA; }
        [data-theme="dark"] .category-btn.selected { background: #374151; border-color: #60A5FA; color: #FFFFFF; }
        [data-theme="dark"] .feature-btn:hover span:first-child { opacity: 1; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; padding: 0; margin: 0; min-height: 100vh; }
        .header { background: var(--card); border-bottom: 1px solid var(--border); padding: 16px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header-subtitle { font-size: 13px; color: var(--text-secondary); }
        .main { max-width: 900px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        .tiles-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 600px) { .tiles-grid { grid-template-columns: 1fr; } }
        .tile { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .tile-full { grid-column: span 2; }
        @media (max-width: 600px) { .tile-full { grid-column: span 1; } }
        .tile-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .tile-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .tile-icon.blue { background: #DBEAFE; color: #1A365D; }
        .tile-icon.green { background: #D1FAE5; color: #059669; }
        .tile-icon.red { background: #FEE2E2; color: #DC2626; }
        .tile-icon.purple { background: #EDE9FE; color: #7C3AED; }
        .tile-title { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; }
        .tile-value { font-size: 28px; font-weight: 700; color: var(--text); }
        .tile-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        [data-theme="dark"] .tile-value { color: #FFFFFF; }
        [data-theme="dark"] .tile-subtitle { color: #E5E7EB; }
        [data-theme="dark"] .tile-value#tax-amount { color: #93C5FD; } /* Very light blue for tax amount in dark mode */
        [data-theme="dark"] .tile-value#total-income { color: #34D399; } /* Bright green for income */
        [data-theme="dark"] .tile-value#total-expenses { color: #F87171; } /* Bright red for expenses */
        .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; }
        .quick-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; border-radius: 12px; font-size: 15px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .quick-btn.income { background: #D1FAE5; color: #059669; }
        .quick-btn.expense { background: #FEE2E2; color: #DC2626; }
        .quick-btn:active { transform: scale(0.98); }
        .feature-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        @media (max-width: 600px) { .feature-grid { grid-template-columns: repeat(2, 1fr); } }
        .feature-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; font-size: 13px; color: var(--text-secondary); transition: all 0.2s; }
        .feature-btn:hover { border-color: var(--primary); background: var(--bg-alt); }
        .feature-btn span:first-child { font-size: 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 24px 0 16px; }
        .section-title { font-size: 18px; font-weight: 600; color: var(--text); }
        .section-link { color: var(--primary); font-size: 14px; cursor: pointer; font-weight: 500; }
        [data-theme="dark"] .section-link { color: #60A5FA; } /* Light blue for visibility in dark mode */
        .transaction { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; }
        .transaction-info { display: flex; align-items: center; gap: 12px; }
        .transaction-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .transaction-details h4 { font-size: 15px; font-weight: 500; margin-bottom: 2px; }
        .transaction-details span { font-size: 13px; color: var(--text-secondary); }
        .transaction-amount { font-size: 17px; font-weight: 600; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); display: flex; padding: 8px 0; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px; cursor: pointer; color: var(--text-secondary); font-size: 11px; border-radius: 8px; margin: 0 4px; }
        .nav-item.active { color: var(--primary); background: #F1F5F9; }
        .nav-item span { font-size: 22px; margin-bottom: 2px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--card); color: var(--text); }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .form-group input::placeholder { color: var(--text-muted); }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500; }
        .category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
        .category-btn { padding: 14px; border: 2px solid var(--border); border-radius: 10px; background: var(--card); cursor: pointer; text-align: center; font-size: 14px; transition: all 0.2s; }
        .category-btn.selected { border-color: var(--primary); background: #F1F5F9; color: var(--primary); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-cta { background: var(--cta); color: white; }  /* Warm Coral for CTAs */
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .vat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .vat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .vat-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .vat-badge.alt { background: #F3F4F6; color: var(--text-secondary); }
        .vat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .vat-row:last-child { border-bottom: none; }
        .vat-row.total { border-top: 2px solid var(--border); margin-top: 8px; padding-top: 16px; font-weight: 600; }
        .mileage-card { background: linear-gradient(135deg, #1A365D 0%, #2C5282 100%); border-radius: 16px; padding: 24px; margin-bottom: 16px; text-align: center; }
        .mileage-value { font-size: 48px; font-weight: 700; color: var(--primary); }
        .mileage-label { font-size: 14px; color: var(--text-secondary); }
        .mileage-deduction { font-size: 24px; font-weight: 600; color: var(--success); margin-top: 8px; }
        .insight-card { background: var(--bg-alt); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .insight-header { font-weight: 600; color: var(--success); margin-bottom: 8px; }
        .insight-text { font-size: 14px; color: var(--text-secondary); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state span { font-size: 48px; margin-bottom: 16px; display: block; }
        .back-header { display: flex; align-items: center; gap: 16px; }
        .back-btn { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); cursor: pointer; font-size: 20px; }
        .back-title { font-size: 20px; font-weight: 600; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        .segmented-tabs { display: flex; background: var(--bg); border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .segmented-tab { flex: 1; padding: 12px; border: none; background: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; color: var(--text-secondary); }
        .segmented-tab.active { background: #F1F5F9; color: var(--primary); box-shadow: var(--shadow); }
        .tax-summary { background: linear-gradient(135deg, #1A365D 0%, #2C5282 100%); border-radius: 16px; padding: 24px; margin-bottom: 16px; }
        .tax-breakdown { background: var(--card); border-radius: 12px; padding: 16px; margin-top: 16px; }
        .tax-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .tax-row:last-child { border-bottom: none; }
        .tax-row.total { border-top: 2px solid var(--border); margin-top: 8px; padding-top: 16px; font-weight: 700; font-size: 18px; }
        .tax-positive { color: var(--success); }
        .tax-negative { color: var(--danger); }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <div class="header">
            <div class="header-brand">
                <div class="header-logo">T</div>
                <div><h1>TradeTax</h1><div class="header-subtitle">UK Sole Trader Finance</div></div>
            </div>
            <button class="header-btn" style="width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer;" onclick="showScreen('settings')">âš™ï¸</button>
        </div>
        <div class="main">
            <div class="tiles-grid">
                <div class="tile tile-full">
                    <div class="tile-header">
                        <div><div class="tile-title">Tax to Set Aside</div><div class="tile-value" id="tax-amount" style="color:var(--primary)">Â£0.00</div><div class="tile-subtitle" id="tax-monthly">Â£0/month remaining</div></div>
                        <div class="tile-icon blue">ğŸ§®</div>
                    </div>
                </div>
                <div class="tile">
                    <div class="tile-header"><div><div class="tile-title">Income YTD</div><div class="tile-value" id="total-income" style="color:var(--success)">Â£0.00</div></div><div class="tile-icon green">ğŸ“ˆ</div></div>
                </div>
                <div class="tile">
                    <div class="tile-header"><div><div class="tile-title">Expenses YTD</div><div class="tile-value" id="total-expenses" style="color:var(--danger)">Â£0.00</div></div><div class="tile-icon red">ğŸ“‰</div></div>
                </div>
                <div class="tile tile-full">
                    <div class="tile-header"><div><div class="tile-title">Net Profit</div><div class="tile-value" id="net-profit">Â£0.00</div><div class="tile-subtitle">After tax deduction</div></div><div class="tile-icon purple">ğŸ’°</div></div>
                </div>
            </div>
            <div class="quick-actions">
                <button class="quick-btn income" onclick="showScreen('income')">ğŸ“¥ Add Income</button>
                <button class="quick-btn expense" onclick="showScreen('expenses')">ğŸ“¤ Add Expense</button>
            </div>
            <div class="feature-grid">
                <button class="feature-btn" onclick="showScreen('invoice')"><span>ğŸ“„</span>Invoice</button>
                <button class="feature-btn" onclick="showScreen('vat')"><span>ğŸ§®</span>VAT</button>
                <button class="feature-btn" onclick="showScreen('mileage')"><span>ğŸš—</span>Mileage</button>
                <button class="feature-btn" onclick="showScreen('forecast')"><span>ğŸ“ˆ</span>Forecast</button>
                <button class="feature-btn" onclick="showScreen('tax-calc')"><span>ğŸ†•</span>Tax Calc</button>
                <button class="feature-btn" onclick="showScreen('reports')"><span>ğŸ“Š</span>Reports</button>
            </div>
            <div class="section-header"><div class="section-title">Recent Activity</div><div class="section-link" onclick="showScreen('reports')">View All â†’</div></div>
            <div id="recent-transactions"><div class="empty-state"><span>ğŸ“</span>No transactions yet<br>Add your first income or expense!</div></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('home')"><span>ğŸ </span>Home</div>
            <div class="nav-item" onclick="showScreen('income')"><span>ğŸ“¥</span>Income</div>
            <div class="nav-item" onclick="showScreen('expenses')"><span>ğŸ“¤</span>Expense</div>
            <div class="nav-item" onclick="showScreen('reports')"><span>ğŸ“Š</span>Reports</div>
            <div class="nav-item" onclick="showScreen('settings')"><span>âš™ï¸</span>Settings</div>
        </div>
    </div>
    
    <!-- NEW: Self-Assessment Tax Calculator -->
    <div id="tax-calc-screen" class="screen">
        <div class="header">
            <div class="back-header">
                <button class="back-btn" onclick="showScreen('home')">â†</button>
                <div class="back-title">Self-Assessment Tax Calculator</div>
            </div>
        </div>
        <div class="main">
            <div class="tax-summary">
                <h3 style="margin-bottom:16px;color:var(--text);">ğŸ“Š Your Tax Breakdown</h3>
                <div class="tile-value" id="calc-net-profit" style="font-size:32px">Â£0.00</div>
                <div class="tile-subtitle">Net Profit (after Mileage deduction)</div>
            </div>
            <div class="tax-breakdown">
                <h4 style="margin-bottom:12px">Tax Calculation (2025-26)</h4>
                <div class="tax-row"><span>Personal Allowance</span><span id="calc-allowance">Â£12,570</span></div>
                <div class="tax-row"><span>Taxable Income</span><span id="calc-taxable">Â£0</span></div>
                <div class="tax-row"><span>Basic Rate (20%)</span><span id="calc-basic" class="tax-negative">Â£0</span></div>
                <div class="tax-row"><span>Higher Rate (40%)</span><span id="calc-higher" class="tax-negative">Â£0</span></div>
                <div class="tax-row"><span>Additional Rate (45%)</span><span id="calc-additional" class="tax-negative">Â£0</span></div>
                <div class="tax-row total"><span>Total Income Tax</span><span id="calc-total-tax" class="tax-negative">Â£0</span></div>
            </div>
            <div class="tax-breakdown" style="margin-top:16px">
                <h4 style="margin-bottom:12px">ğŸ‡¬ğŸ‡§ National Insurance</h4>
                <div class="tax-row"><span>Class 2 NIC (Â£3.45/week)</span><span id="calc-class2" class="tax-negative">Â£0</span></div>
                <div class="tax-row"><span>Class 4 NIC (9% + 2%)</span><span id="calc-class4" class="tax-negative">Â£0</span></div>
                <div class="tax-row total"><span>Total NIC</span><span id="calc-total-nic" class="tax-negative">Â£0</span></div>
            </div>
            <div class="tax-breakdown" style="margin-top:16px;background:#F0FDF4;border-color:#BBF7D0;">
                <h4 style="margin-bottom:12px;color:#166534">ğŸ’° Summary</h4>
                <div class="tax-row"><span>Total Tax & NIC</span><span id="calc-total-all" class="tax-negative" style="font-size:20px">Â£0</span></div>
                <div class="tax-row" style="border-top:2px solid #166534;margin-top:8px;padding-top:16px;"><span>âœ… Take Home</span><span id="calc-take-home" class="tax-positive" style="font-size:20px">Â£0</span></div>
                <div class="tax-row" style="margin-top:8px;"><span>Effective Tax Rate</span><span id="calc-effective">0%</span></div>
            </div>
            <div class="insight-card">
                <div class="insight-header">ğŸ’¡ Tax Tips</div>
                <div class="insight-text" id="calc-tips">Add your income and expenses to see personalized tax tips!</div>
            </div>
            <button class="btn btn-primary" style="margin-top:16px" onclick="exportTaxSummary()">ğŸ“¥ Export Summary</button>
        </div>
    </div>
    
    <!-- Income Screen -->
    <div id="income-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Add Income</div></div></div>
        <div class="main">
            <div class="tile">
                <div class="form-group"><label>Amount Received</label><input type="number" id="income-amount" placeholder="0.00" step="0.01"></div>
                <div class="form-group">
                    <label>Category</label>
                    <div class="category-grid" id="income-categories">
                        <button class="category-btn selected" data-category="client" onclick="selectCategory(this,'income')">ğŸ’¼ Client</button>
                        <button class="category-btn" data-category="sale" onclick="selectCategory(this,'income')">ğŸ›’ Sale</button>
                        <button class="category-btn" data-category="refund" onclick="selectCategory(this,'income')">â†©ï¸ Refund</button>
                        <button class="category-btn" data-category="other" onclick="selectCategory(this,'income')">â‹¯ Other</button>
                    </div>
                </div>
                <div class="form-group"><label>Description (optional)</label><input type="text" id="income-description" placeholder="Client name, project"></div>
                <button class="btn btn-primary" onclick="saveIncome()">ğŸ’¾ Save Income</button>
            </div>
        </div>
    </div>
    
    <!-- Expenses Screen -->
    <div id="expenses-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Add Expense</div></div></div>
        <div class="main">
            <!-- Receipt Scanner Button -->
            <button class="btn btn-cta" style="margin-bottom:16px;padding:14px;" onclick="openReceiptScanner()">
                ğŸ“· Scan Receipt
            </button>
            <div class="tile">
                <div class="form-group"><label>Amount Spent</label><input type="number" id="expense-amount" placeholder="0.00" step="0.01"></div>
                <div class="form-group">
                    <label>Category</label>
                    <div class="category-grid" id="expense-categories">
                        <button class="category-btn selected" data-category="materials" onclick="selectCategory(this,'expense')">ğŸ”§ Materials</button>
                        <button class="category-btn" data-category="travel" onclick="selectCategory(this,'expense')">ğŸš— Travel</button>
                        <button class="category-btn" data-category="equipment" onclick="selectCategory(this,'expense')">ğŸ› ï¸ Equipment</button>
                        <button class="category-btn" data-category="meals" onclick="selectCategory(this,'expense')">ğŸ½ï¸ Meals</button>
                        <button class="category-btn" data-category="office" onclick="selectCategory(this,'expense')">ğŸ–¥ï¸ Office</button>
                        <button class="category-btn" data-category="utilities" onclick="selectCategory(this,'expense')">ğŸ’¡ Utilities</button>
                        <button class="category-btn" data-category="insurance" onclick="selectCategory(this,'expense')">ğŸ›¡ï¸ Insurance</button>
                        <button class="category-btn" data-category="other" onclick="selectCategory(this,'expense')">â‹¯ Other</button>
                    </div>
                </div>
                <div class="form-group"><label>Description (optional)</label><input type="text" id="expense-description" placeholder="What was this for?"></div>
                <button class="btn btn-success" onclick="saveExpense()">ğŸ’¾ Save Expense</button>
            </div>
        </div>
    </div>
    
    <!-- VAT Screen -->
    <div id="vat-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">VAT Calculator</div></div></div>
        <div class="main">
            <div class="tile">
                <div class="form-group"><label>Taxable Turnover</label><input type="number" id="vat-turnover" placeholder="0.00" oninput="calculateVAT()"></div>
                <div class="form-group"><label>VAT on Purchases</label><input type="number" id="vat-purchases" placeholder="0.00" oninput="calculateVAT()"></div>
            </div>
            <div class="vat-card">
                <div class="vat-header"><span style="font-weight:600">Standard Rate (20%)</span><span class="vat-badge alt">Standard</span></div>
                <div class="vat-row"><span>Output VAT</span><span id="vat-output">Â£0.00</span></div>
                <div class="vat-row"><span style="color:var(--success)">- Input VAT</span><span id="vat-input" style="color:var(--success)">Â£0.00</span></div>
                <div class="vat-row total"><span>Net VAT Due</span><span id="vat-net" style="font-size:20px">Â£0.00</span></div>
            </div>
            <div class="vat-card">
                <div class="vat-header">
                    <span style="font-weight:600">Flat Rate</span>
                    <select id="vat-flat-rate" onchange="calculateVAT()" style="width:auto;padding:8px 12px;font-size:14px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:8px;">
                        <option value="12">12% - Consulting</option>
                        <option value="14.5">14.5% - IT</option>
                        <option value="10">10% - Construction</option>
                    </select>
                </div>
                <div class="vat-row"><span>Flat VAT</span><span id="vat-flat">Â£0.00</span></div>
                <div class="vat-row total"><span>Net VAT Due</span><span id="vat-flat-net" style="font-size:20px">Â£0.00</span></div>
            </div>
        </div>
    </div>
    
    <!-- Mileage Screen -->
    <div id="mileage-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Mileage Tracker</div></div></div>
        <div class="main">
            <div class="mileage-card">
                <div class="mileage-label">Total Miles This Year</div>
                <div class="mileage-value" id="mileage-total">0</div>
                <div class="mileage-deduction">Tax Deduction: Â£<span id="mileage-deduction">0</span></div>
            </div>
            <div class="tile">
                <h3 style="margin-bottom:16px;color:var(--text);">Log Trip</h3>
                <div class="form-group"><label>Date</label><input type="date" id="mileage-date"></div>
                <div class="form-group"><label>Purpose</label><input type="text" id="mileage-purpose" placeholder="Client meeting..."></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div class="form-group"><label>From</label><input type="text" id="mileage-from" placeholder="Office"></div>
                    <div class="form-group"><label>To</label><input type="text" id="mileage-to" placeholder="Client site"></div>
                </div>
                <div class="form-group"><label>Miles</label><input type="number" id="mileage-miles" placeholder="0"></div>
                <button class="btn btn-primary" onclick="saveMileage()">Add Trip</button>
            </div>
            <div id="mileage-list" style="margin-top:16px"></div>
        </div>
    </div>
    
    <!-- Forecast Screen -->
    <div id="forecast-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Cash Flow Forecast</div></div></div>
        <div class="main">
            <div class="segmented-tabs">
                <button class="segmented-tab active" onclick="setForecastPeriod('month')">Month</button>
                <button class="segmented-tab" onclick="setForecastPeriod('quarter')">Quarter</button>
                <button class="segmented-tab" onclick="setForecastPeriod('year')">Year</button>
            </div>
            <div class="tile">
                <div class="tile-header">
                    <div><div class="tile-title">Year to Date</div><div class="tile-value" id="ytd-net" style="font-size:24px">Â£0</div></div>
                    <div class="tile-icon blue">ğŸ“Š</div>
                </div>
                <div class="row"><span>Income</span><span id="ytd-income" style="color:var(--success)">Â£0</span></div>
                <div class="row"><span>Expenses</span><span id="ytd-expense" style="color:var(--danger)">Â£0</span></div>
            </div>
        </div>
    </div>
    
    <!-- Reports Screen -->
    <div id="reports-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Reports</div></div></div>
        <div class="main">
            <div class="segmented-tabs">
                <button class="segmented-tab active" onclick="setReportPeriod('month')">This Month</button>
                <button class="segmented-tab" onclick="setReportPeriod('quarter')">Quarter</button>
                <button class="segmented-tab" onclick="setReportPeriod('year')">Year</button>
            </div>
            <div class="tile"><h3 style="margin-bottom:16px;color:var(--text);">Income Sources</h3><div id="income-breakdown"></div></div>
            <div class="tile" style="margin-top:16px"><h3 style="margin-bottom:16px;color:var(--text);">Expense Breakdown</h3><div id="expense-breakdown"></div></div>
            <button class="btn btn-outline" style="margin-top:20px" onclick="exportCSV()">ğŸ“¥ Export CSV</button>
        </div>
    </div>
    
    <!-- Invoice Screen -->
    <div id="invoice-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Create Invoice</div></div></div>
        <div class="main">
            <div class="tile"><h3 style="margin-bottom:16px;color:var(--text);">Client Details</h3>
                <div class="form-group"><label>Client Name</label><input type="text" id="invoice-client" placeholder="Company or Name"></div>
                <div class="form-group"><label>Email</label><input type="email" id="invoice-email" placeholder="client@email.com"></div>
            </div>
            <div class="tile" style="margin-top:16px"><h3 style="margin-bottom:16px;color:var(--text);">Items</h3><div id="invoice-items"></div><button class="btn btn-outline" onclick="addInvoiceItem()" style="margin-top:12px">+ Add Item</button></div>
            <div class="tile" style="margin-top:16px">
                <div class="row"><span>Subtotal</span><span id="invoice-subtotal">Â£0.00</span></div>
                <div class="row"><span>VAT (20%)</span><span id="invoice-vat">Â£0.00</span></div>
                <div class="row" style="border-top:2px solid #333;padding-top:12px;font-weight:bold;"><span>Total</span><span id="invoice-total" style="font-size:24px;color:var(--primary)">Â£0.00</span></div>
            </div>
            <button class="btn btn-primary" style="margin-top:16px" onclick="generateInvoice()">ğŸ“„ Generate Invoice</button>
        </div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
        <div class="header"><div class="back-header"><button class="back-btn" onclick="showScreen('home')">â†</button><div class="back-title">Settings</div></div></div>
        <div class="main">
            <!-- Theme Toggle -->
            <div class="tile"><h3 style="margin-bottom:16px;color:var(--text);">ğŸ¨ Theme</h3>
                <div style="display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--bg-alt);border-radius:12px;border:1px solid #FFFFFF;">
                    <div>
                        <div style="font-weight:600;font-size:16px;color:var(--text);" id="theme-label">Light Mode</div>
                        <div style="font-size:13px;color:var(--text-muted);margin-top:4px;">Tap to switch themes</div>
                    </div>
                    <div onclick="toggleTheme()" style="position:relative;width:60px;height:32px;cursor:pointer;border:2px solid #FFFFFF;border-radius:32px;background:#E5E7EB;">
                        <span id="toggle-knob" style="position:absolute;top:2px;left:2px;width:24px;height:24px;background-color:white;border-radius:50%;transition:0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></span>
                    </div>
                </div>
            </div>
            
            <div class="tile" style="margin-top:16px"><h3 style="margin-bottom:16px;color:var(--text);">Export Data</h3>
                <button class="btn btn-outline" onclick="exportCSV()">ğŸ“¥ Export to CSV</button>
                <p style="color:var(--text-muted);font-size:14px;margin-top:8px">Download for your accountant</p>
            </div>
            <div class="tile" style="margin-top:16px">
                <h3 style="margin-bottom:16px;color:var(--text);">Tax Settings (2025-26)</h3>
                <div class="form-group"><label>Personal Allowance</label><input type="number" id="setting-allowance" value="12570" onchange="saveSettings()"></div>
                <div class="form-group"><label>Basic Rate Threshold</label><input type="number" id="setting-basic" value="50270" onchange="saveSettings()"></div>
                <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
            </div>
            <div class="tile" style="margin-top:16px">
                <h3 style="margin-bottom:16px;color:var(--text);">Account</h3>
                <button class="btn btn-outline" onclick="logout()">ğŸšª Log Out</button>
            </div>
            <div class="tile" style="margin-top:16px">
                <h3 style="margin-bottom:16px;color:var(--text);">Danger Zone</h3>
                <button class="btn btn-outline" onclick="clearAllData()" style="border-color:var(--danger);color:var(--danger);">ğŸ—‘ï¸ Clear All Data</button>
                <p style="color:var(--text-secondary);font-size:14px;margin-top:8px">This will delete all transactions and mileage logs</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://issryxbhnwezxwrjhznq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_Ng-4FojiB1es07oJ0w1_Xg_7pXRe6C_';
        
        // Create Supabase client
        var client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        var supabase = client;
        
        // Auth check - redirect to login if not authenticated
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return false;
            }
            // Load user's data from Supabase
            await loadDataFromSupabase();
            updateUI();
            return session;
        }
        
        // Logout function
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
        
        // Data Storage (local fallback for demo)
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let mileageTrips = JSON.parse(localStorage.getItem('mileage_trips') || '[]');
        let invoiceItems = [];
        let selectedIncomeCategory = 'client';
        let selectedExpenseCategory = 'materials';
        
        const CATEGORY_NAMES = {
            income: { client: 'Client Payment', sale: 'Sale', refund: 'Refund', other: 'Other' },
            expense: { materials: 'Materials', travel: 'Travel', equipment: 'Equipment', meals: 'Meals', office: 'Office', utilities: 'Utilities', insurance: 'Insurance', other: 'Other' }
        };
        
        // Load data from Supabase when user is authenticated
        async function loadDataFromSupabase() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return;
            
            const userId = session.user.id;
            
            // Load transactions from Supabase
            const { data: supabaseTx, error: txError } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', userId)
                .order('date', { ascending: false });
            
            if (!txError && supabaseTx && supabaseTx.length > 0) {
                // Merge Supabase data with localStorage (Supabase is source of truth)
                transactions = supabaseTx.map(tx => ({
                    id: tx.id || Date.now(),
                    type: tx.type,
                    category: tx.category,
                    amount: tx.amount,
                    description: tx.description,
                    date: tx.date
                }));
                localStorage.setItem('transactions', JSON.stringify(transactions));
            }
            
            // Load mileage trips from Supabase
            const { data: supabaseMileage, error: mileageError } = await supabase
                .from('mileage_trips')
                .select('*')
                .eq('user_id', userId)
                .order('date', { ascending: false });
            
            if (!mileageError && supabaseMileage && supabaseMileage.length > 0) {
                mileageTrips = supabaseMileage.map(trip => ({
                    id: trip.id || Date.now(),
                    date: trip.date,
                    purpose: trip.purpose,
                    from: trip.from,
                    to: trip.to,
                    miles: trip.miles
                }));
                localStorage.setItem('mileage_trips', JSON.stringify(mileageTrips));
            }
        }
        
        // Navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId + '-screen').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navMap = { 'home': 0, 'income': 1, 'expenses': 2, 'reports': 3, 'settings': 4 };
            if (navMap[screenId] !== undefined) {
                document.querySelectorAll('.nav-item')[navMap[screenId]].classList.add('active');
            }
            if (screenId === 'tax-calc') updateTaxCalculator();
            if (screenId === 'home' || screenId === 'reports') updateUI();
            if (screenId === 'mileage') updateMileageUI();
            if (screenId === 'forecast') updateForecast();
            if (screenId === 'invoice') updateInvoiceUI();
            if (screenId === 'settings') loadSettings();
        }
        
        // ===== THEME MANAGEMENT =====
        
        let isDarkMode = false;
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
            
            updateThemeUI();
        }
        
        function updateThemeUI() {
            const label = document.getElementById('theme-label');
            const container = document.querySelector('[onclick="toggleTheme()"]');
            const knob = document.getElementById('toggle-knob');
            
            if (label) {
                label.textContent = isDarkMode ? 'Dark Mode' : 'Light Mode';
                label.style.color = isDarkMode ? '#FFFFFF' : 'var(--text)';
            }
            
            if (container && knob) {
                if (isDarkMode) {
                    container.style.backgroundColor = '#374151';
                    container.style.borderColor = '#4B5563';
                    knob.style.transform = 'translateX(28px)';
                } else {
                    container.style.backgroundColor = '#E5E7EB';
                    container.style.borderColor = '#FFFFFF';
                    knob.style.transform = 'translateX(0)';
                }
            }
        }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark') {
                isDarkMode = true;
            } else if (savedTheme === 'light') {
                isDarkMode = false;
            } else {
                // Default to light, or check system preference
                isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            // Update toggle on page load
            setTimeout(updateThemeUI, 100);
        }
        
        function selectCategory(btn, type) {
            const container = type === 'income' ? document.getElementById('income-categories') : document.getElementById('expense-categories');
            container.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            if (type === 'income') selectedIncomeCategory = btn.dataset.category;
            else selectedExpenseCategory = btn.dataset.category;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount);
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-GB');
        }
        
        function getCategoryName(type, category) {
            return CATEGORY_NAMES[type][category] || category;
        }
        
        function updateUI() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const mileageDeduction = mileageTrips.reduce((sum, t) => sum + (t.miles * 0.45), 0);
            const netProfit = income - expenses - mileageDeduction;
            const monthsRemaining = Math.max(1, 12 - new Date().getMonth());
            
            // Get tax and NIC calculations
            const tax = calculateIncomeTax(netProfit);
            const nic = calculateNIC(netProfit);
            const totalTax = tax.total + nic.total;
            
            const setAsidePerMonth = totalTax / monthsRemaining;
            
            document.getElementById('tax-amount').textContent = formatCurrency(totalTax);
            document.getElementById('tax-monthly').textContent = formatCurrency(setAsidePerMonth) + '/month remaining';
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expenses').textContent = formatCurrency(expenses);
            document.getElementById('net-profit').textContent = formatCurrency(netProfit);
            document.getElementById('net-profit').style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const recentContainer = document.getElementById('recent-transactions');
            if (transactions.length === 0) {
                recentContainer.innerHTML = '<div class="empty-state"><span>ğŸ“</span>No transactions yet<br>Add your first income or expense!</div>';
            } else {
                recentContainer.innerHTML = transactions.slice(0, 5).map(tx => `
                    <div class="transaction">
                        <div class="transaction-info">
                            <div class="transaction-icon" style="background:${tx.type==='income'?'#D1FAE5':'#FEE2E2'}">${tx.type==='income'?'ğŸ“ˆ':'ğŸ“‰'}</div>
                            <div class="transaction-details">
                                <h4>${getCategoryName(tx.type, tx.category)}</h4>
                                <span>${tx.description || formatDate(tx.date)}</span>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="transaction-amount ${tx.type==='income'?'positive':'negative'}">${tx.type==='income'?'+':'-'}${formatCurrency(tx.amount)}</div>
                            <button onclick="deleteTransaction(${tx.id})" style="background:none;border:none;cursor:pointer;font-size:16px;opacity:0.5;">âœ•</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        async function saveIncome() {
            const amount = parseFloat(document.getElementById('income-amount').value);
            if (!amount || amount <= 0) { alert('Please enter a valid amount'); return; }
            const tx = { id: Date.now(), type: 'income', category: selectedIncomeCategory, amount, description: document.getElementById('income-description').value, date: new Date().toISOString() };
            transactions.unshift(tx);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Save to Supabase
            try {
                const { data: { user } } = await supabase.auth.getUser();
                supabase.from('transactions').insert({
                    user_id: user?.id,
                    type: 'income',
                    category: selectedIncomeCategory,
                    amount: amount,
                    description: document.getElementById('income-description').value,
                    date: new Date().toISOString()
                });
            } catch (e) {
                console.log('Supabase sync skipped:', e.message);
            }
            
            document.getElementById('income-amount').value = '';
            document.getElementById('income-description').value = '';
            alert('Income saved! âœ“');
            showScreen('home');
        }
        
        async function saveExpense() {
            const amount = parseFloat(document.getElementById('expense-amount').value);
            if (!amount || amount <= 0) { alert('Please enter a valid amount'); return; }
            const tx = { id: Date.now(), type: 'expense', category: selectedExpenseCategory, amount, description: document.getElementById('expense-description').value, date: new Date().toISOString() };
            transactions.unshift(tx);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Save to Supabase
            try {
                const { data: { user } } = await supabase.auth.getUser();
                supabase.from('transactions').insert({
                    user_id: user?.id,
                    type: 'expense',
                    category: selectedExpenseCategory,
                    amount: amount,
                    description: document.getElementById('expense-description').value,
                    date: new Date().toISOString()
                });
            } catch (e) {
                console.log('Supabase sync skipped:', e.message);
            }
            
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-description').value = '';
            alert('Expense saved! âœ“');
            showScreen('home');
        }
        
        function calculateVAT() {
            const turnover = parseFloat(document.getElementById('vat-turnover').value) || 0;
            const purchases = parseFloat(document.getElementById('vat-purchases').value) || 0;
            const outputVAT = turnover * 0.20;
            const inputVAT = purchases;
            document.getElementById('vat-output').textContent = formatCurrency(outputVAT);
            document.getElementById('vat-input').textContent = formatCurrency(inputVAT);
            document.getElementById('vat-net').textContent = formatCurrency(outputVAT - inputVAT);
            
            const flatRate = parseFloat(document.getElementById('vat-flat-rate').value) / 100;
            const flatVAT = turnover * flatRate;
            document.getElementById('vat-flat').textContent = formatCurrency(flatVAT);
            document.getElementById('vat-flat-net').textContent = formatCurrency(flatVAT - inputVAT);
        }
        
        // MILEAGE FUNCTIONS
        async function saveMileage() {
            const miles = parseFloat(document.getElementById('mileage-miles').value);
            if (!miles || miles <= 0) { alert('Please enter miles'); return; }
            const trip = { id: Date.now(), date: document.getElementById('mileage-date').value || new Date().toISOString().split('T')[0], purpose: document.getElementById('mileage-purpose').value, from: document.getElementById('mileage-from').value, to: document.getElementById('mileage-to').value, miles };
            mileageTrips.unshift(trip);
            localStorage.setItem('mileage_trips', JSON.stringify(mileageTrips));
            
            // Save to Supabase
            try {
                const { data: { user } } = await supabase.auth.getUser();
                supabase.from('mileage_trips').insert({
                    user_id: user?.id,
                    date: document.getElementById('mileage-date').value || new Date().toISOString().split('T')[0],
                    purpose: document.getElementById('mileage-purpose').value,
                    from: document.getElementById('mileage-from').value,
                    to: document.getElementById('mileage-to').value,
                    miles: miles
                });
            } catch (e) {
                console.log('Supabase sync skipped:', e.message);
            }
            
            document.getElementById('mileage-miles').value = '';
            document.getElementById('mileage-purpose').value = '';
            alert('Trip saved! âœ“');
            updateMileageUI();
        }
        
        function updateMileageUI() {
            const totalMiles = mileageTrips.reduce((sum, t) => sum + t.miles, 0);
            const deduction = totalMiles * 0.45;
            document.getElementById('mileage-total').textContent = totalMiles.toLocaleString();
            document.getElementById('mileage-deduction').textContent = deduction.toFixed(2);
            
            const list = document.getElementById('mileage-list');
            if (mileageTrips.length === 0) {
                list.innerHTML = '<div class="empty-state"><span>ğŸš—</span>No trips logged yet</div>';
            } else {
                list.innerHTML = mileageTrips.slice(0, 10).map(t => `
                    <div class="transaction">
                        <div class="transaction-info">
                            <div class="transaction-icon" style="background:#DBEAFE">ğŸš—</div>
                            <div class="transaction-details">
                                <h4>${t.purpose || 'Trip'}</h4>
                                <span>${t.from} â†’ ${t.to} â€¢ ${t.miles} miles</span>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="transaction-amount positive">-${formatCurrency(t.miles * 0.45)}</div>
                            <button onclick="deleteMileage(${t.id})" style="background:none;border:none;cursor:pointer;font-size:16px;opacity:0.5;">âœ•</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function deleteMileage(id) {
            if (confirm('Delete this trip?')) {
                mileageTrips = mileageTrips.filter(t => t.id !== id);
                localStorage.setItem('mileage_trips', JSON.stringify(mileageTrips));
                
                // Delete from Supabase
                supabase.from('mileage_trips').delete().eq('id', id).catch(err => console.log('Supabase delete mileage:', err.message));
                
                updateMileageUI();
            }
        }
        
        // INVOICE FUNCTIONS
        function addInvoiceItem() {
            invoiceItems.push({ description: '', quantity: 1, price: 0 });
            updateInvoiceUI();
        }
        
        function deleteInvoiceItem(index) {
            invoiceItems.splice(index, 1);
            updateInvoiceUI();
        }
        
        function updateInvoiceItem(index, field, value) {
            invoiceItems[index][field] = field === 'quantity' || field === 'price' ? parseFloat(value) : value;
            updateInvoiceTotals();
        }
        
        function updateInvoiceUI() {
            const container = document.getElementById('invoice-items');
            if (invoiceItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><span>ğŸ“„</span>No items yet. Click "+ Add Item"</div>';
            } else {
                container.innerHTML = invoiceItems.map((item, i) => `
                    <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;margin-bottom:8px;align-items:center;">
                        <input type="text" placeholder="Description" value="${item.description}" onchange="updateInvoiceItem(${i}, 'description', this.value)" style="padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);">
                        <input type="number" placeholder="Qty" value="${item.quantity}" onchange="updateInvoiceItem(${i}, 'quantity', this.value)" style="padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);">
                        <input type="number" placeholder="Â£" value="${item.price}" onchange="updateInvoiceItem(${i}, 'price', this.value)" style="padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);">
                        <button onclick="deleteInvoiceItem(${i})" style="background:#FEE2E2;color:#DC2626;border:none;border-radius:8px;padding:10px;">âœ•</button>
                    </div>
                `).join('');
            }
            updateInvoiceTotals();
        }
        
        function updateInvoiceTotals() {
            const subtotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const vat = subtotal * 0.20;
            const total = subtotal + vat;
            document.getElementById('invoice-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('invoice-vat').textContent = formatCurrency(vat);
            document.getElementById('invoice-total').textContent = formatCurrency(total);
        }
        
        function generateInvoice() {
            const client = document.getElementById('invoice-client').value;
            const subtotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const vat = subtotal * 0.20;
            const total = subtotal + vat;
            const invoiceNumber = 'INV-' + Date.now().toString().slice(-6);
            
            let invoiceHTML = `<!DOCTYPE html>
<html>
<head>
    <title>Invoice ${invoiceNumber}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #1A365D; border-bottom: 2px solid #1A365D; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f5f5f5; }
        .totals { margin-left: auto; max-width: 300px; }
        .totals div { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd; }
        .totals .total { font-weight: bold; font-size: 18px; border-bottom: none; }
    </style>
</head>
<body>
    <h1>INVOICE</h1>
    <p><strong>Invoice Number:</strong> ${invoiceNumber}</p>
    <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
    <p><strong>Client:</strong> ${client}</p>
    
    <table>
        <thead>
            <tr><th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr>
        </thead>
        <tbody>
            ${invoiceItems.map(item => `
                <tr>
                    <td>${item.description}</td>
                    <td>${item.quantity}</td>
                    <td>Â£${item.price.toFixed(2)}</td>
                    <td>Â£${(item.quantity * item.price).toFixed(2)}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <div class="totals">
        <div><span>Subtotal:</span><span>Â£${subtotal.toFixed(2)}</span></div>
        <div><span>VAT (20%):</span><span>Â£${vat.toFixed(2)}</span></div>
        <div class="total"><span>TOTAL:</span><span>Â£${total.toFixed(2)}</span></div>
    </div>
</body>
</html>`;
            
            // Download as HTML file
            const blob = new Blob([invoiceHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoice-${invoiceNumber}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // REPORT FUNCTIONS
        function setReportPeriod(period) {
            document.querySelectorAll('#reports-screen .segmented-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            updateReports();
        }
        
        function updateReports() {
            const now = new Date();
            let filtered = transactions;
            
            const incomeContainer = document.getElementById('income-breakdown');
            const expenseContainer = document.getElementById('expense-breakdown');
            
            const incomeByCat = {};
            const expenseByCat = {};
            
            filtered.filter(t => t.type === 'income').forEach(t => {
                incomeByCat[t.category] = (incomeByCat[t.category] || 0) + t.amount;
            });
            filtered.filter(t => t.type === 'expense').forEach(t => {
                expenseByCat[t.category] = (expenseByCat[t.category] || 0) + t.amount;
            });
            
            incomeContainer.innerHTML = Object.entries(incomeByCat).map(([cat, amount]) => `
                <div class="row"><span>${getCategoryName('income', cat)}</span><span style="color:var(--success)">${formatCurrency(amount)}</span></div>
            `).join('') || '<div class="empty-state">No income recorded</div>';
            
            expenseContainer.innerHTML = Object.entries(expenseByCat).map(([cat, amount]) => `
                <div class="row"><span>${getCategoryName('expense', cat)}</span><span style="color:var(--danger)">${formatCurrency(amount)}</span></div>
            `).join('') || '<div class="empty-state">No expenses recorded</div>';
        }
        
        // FORECAST FUNCTIONS
        function setForecastPeriod(period) {
            document.querySelectorAll('#forecast-screen .segmented-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            updateForecast();
        }
        
        function updateForecast() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const net = income - expenses;
            document.getElementById('ytd-net').textContent = formatCurrency(net);
            document.getElementById('ytd-income').textContent = formatCurrency(income);
           document.getElementById('ytd-expense').textContent = formatCurrency(expenses);
        }
        
        // EXPORT FUNCTIONS
        function exportCSV() {
            let csv = 'Date,Type,Category,Amount,Description\n';
            transactions.forEach(t => {
                csv += `"${new Date(t.date).toLocaleDateString()}","${t.type}","${getCategoryName(t.type, t.category)}","${t.amount}","${t.description||''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tradetax-export.csv';
            a.click();
        }
        
        // SETTINGS FUNCTIONS
        function saveSettings() {
            const settings = {
                allowance: parseFloat(document.getElementById('setting-allowance').value) || 12570,
                basic: parseFloat(document.getElementById('setting-basic').value) || 50270
            };
            localStorage.setItem('tradetax-settings', JSON.stringify(settings));
            alert('Settings saved! âœ“');
        }
        
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('tradetax-settings') || '{}');
            if (saved.allowance) document.getElementById('setting-allowance').value = saved.allowance;
            if (saved.basic) document.getElementById('setting-basic').value = saved.basic;
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                if (confirm('Really sure? All transactions and mileage logs will be lost.')) {
                    localStorage.removeItem('transactions');
                    localStorage.removeItem('mileage_trips');
                    transactions = [];
                    mileageTrips = [];
                    updateUI();
                    updateMileageUI();
                    alert('All data cleared.');
                }
            }
        }
        
        // DELETE TRANSACTION
        function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                
                // Delete from Supabase
                supabase.from('transactions').delete().eq('id', id).catch(err => console.log('Supabase delete transaction:', err.message));
                
                updateUI();
            }
        }
        
        // NEW: SELF-ASSESSMENT TAX CALCULATOR
        function calculateIncomeTax(annualProfit) {
            const PA = 12570;
            const BASIC_THRESHOLD = 50270;
            const HIGHER_THRESHOLD = 125140;
            
            let allowance = PA;
            if (annualProfit > 100000) {
                allowance = Math.max(0, PA - ((annualProfit - 100000) / 2));
            }
            
            const taxable = Math.max(0, annualProfit - allowance);
            let taxBasic = 0, taxHigher = 0, taxAdditional = 0, totalTax = 0;
            
            if (taxable > HIGHER_THRESHOLD) {
                taxAdditional = (taxable - HIGHER_THRESHOLD) * 0.45;
                taxHigher = (HIGHER_THRESHOLD - BASIC_THRESHOLD) * 0.40;
                taxBasic = BASIC_THRESHOLD * 0.20;
            } else if (taxable > BASIC_THRESHOLD) {
                taxHigher = (taxable - BASIC_THRESHOLD) * 0.40;
                taxBasic = BASIC_THRESHOLD * 0.20;
            } else {
                taxBasic = taxable * 0.20;
            }
            
            totalTax = taxBasic + taxHigher + taxAdditional;
            return { basic: taxBasic, higher: taxHigher, additional: taxAdditional, total: totalTax, taxable: taxable, allowance: allowance };
        }
        
        function calculateNIC(annualProfit) {
            const CLASS2_RATE = 3.45; // per week
            const CLASS2_WEEKS = 52;
            const CLASS4_THRESHOLD = 12570;
            const CLASS4_UPPER = 50270;
            
            // Class 2 (flat rate for self-employed)
            const class2 = annualProfit >= CLASS4_THRESHOLD ? CLASS2_RATE * CLASS2_WEEKS : 0;
            
            // Class 4 (9% on profits between LEL and UPL, 2% above UPL)
            let class4 = 0;
            if (annualProfit > CLASS4_THRESHOLD) {
                const aboveLEL = Math.max(0, annualProfit - CLASS4_THRESHOLD);
                const between = Math.min(aboveLEL, CLASS4_UPPER - CLASS4_THRESHOLD);
                const aboveUPL = Math.max(0, annualProfit - CLASS4_UPPER);
                class4 = (between * 0.09) + (aboveUPL * 0.02);
            }
            
            return { class2, class4, total: class2 + class4 };
        }
        
        function updateTaxCalculator() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const mileageDeduction = mileageTrips.reduce((sum, t) => sum + (t.miles * 0.45), 0);
            const netProfit = Math.max(0, income - expenses - mileageDeduction);
            
            document.getElementById('calc-net-profit').textContent = formatCurrency(netProfit);
            
            // Income Tax
            const tax = calculateIncomeTax(netProfit);
            const nic = calculateNIC(netProfit);
            
            document.getElementById('calc-allowance').textContent = formatCurrency(tax.allowance);
            document.getElementById('calc-taxable').textContent = formatCurrency(tax.taxable);
            document.getElementById('calc-basic').textContent = formatCurrency(tax.basic);
            document.getElementById('calc-higher').textContent = formatCurrency(tax.higher);
            document.getElementById('calc-additional').textContent = formatCurrency(tax.additional);
            document.getElementById('calc-total-tax').textContent = formatCurrency(tax.total);
            
            // NIC
            document.getElementById('calc-class2').textContent = formatCurrency(nic.class2);
            document.getElementById('calc-class4').textContent = formatCurrency(nic.class4);
            document.getElementById('calc-total-nic').textContent = formatCurrency(nic.total);
            
            // Summary
            const totalTax = tax.total + nic.total;
            const takeHome = netProfit - totalTax;
            const effectiveRate = netProfit > 0 ? ((totalTax / netProfit) * 100).toFixed(1) : 0;
            
            document.getElementById('calc-total-all').textContent = formatCurrency(totalTax);
            document.getElementById('calc-take-home').textContent = formatCurrency(takeHome);
            document.getElementById('calc-effective').textContent = effectiveRate + '%';
            
            // Tax Tips
            let tips = [];
            if (mileageDeduction < income * 0.05) tips.push('ğŸ“ Log more business mileage - you can claim 45p per mile!');
            if (expenses === 0) tips.push('ğŸ§¾ Don\'t forget to log business expenses to reduce your tax!');
            if (netProfit > 50270) tips.push('ğŸ’¡ You\'re in the higher tax band. Consider pension contributions to reduce taxable income.');
            if (tips.length === 0) tips.push('âœ¨ Your records look good! Keep tracking those transactions.');
            document.getElementById('calc-tips').innerHTML = tips.join('<br><br>');
        }
        
        function exportTaxSummary() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const mileageDeduction = mileageTrips.reduce((sum, t) => sum + (t.miles * 0.45), 0);
            const netProfit = Math.max(0, income - expenses - mileageDeduction);
            const tax = calculateIncomeTax(netProfit);
            const nic = calculateNIC(netProfit);
            
            let summary = `TAX SUMMARY (2025-26)\n`;
            summary += `======================\n\n`;
            summary += `Income: ${formatCurrency(income)}\n`;
            summary += `Expenses: ${formatCurrency(expenses)}\n`;
            summary += `Mileage Deduction: ${formatCurrency(mileageDeduction)}\n`;
            summary += `Net Profit: ${formatCurrency(netProfit)}\n`;
            summary += `Personal Allowance: ${formatCurrency(tax.allowance)}\n`;
            summary += `Taxable Income: ${formatCurrency(tax.taxable)}\n\n`;
            summary += `--- INCOME TAX ---\n`;
            summary += `Basic (20%): ${formatCurrency(tax.basic)}\n`;
            summary += `Higher (40%): ${formatCurrency(tax.higher)}\n`;
            summary += `Additional (45%): ${formatCurrency(tax.additional)}\n`;
            summary += `Total Income Tax: ${formatCurrency(tax.total)}\n\n`;
            summary += `--- NATIONAL INSURANCE ---\n`;
            summary += `Class 2 NIC: ${formatCurrency(nic.class2)}\n`;
            summary += `Class 4 NIC: ${formatCurrency(nic.class4)}\n`;
            summary += `Total NIC: ${formatCurrency(nic.total)}\n\n`;
            summary += `======================\n`;
            summary += `TOTAL TAX & NIC: ${formatCurrency(tax.total + nic.total)}\n`;
            summary += `TAKE HOME: ${formatCurrency(netProfit - tax.total - nic.total)}\n`;
            summary += `Effective Rate: ${netProfit > 0 ? ((tax.total + nic.total) / netProfit * 100).toFixed(1) : 0}%\n`;
            
            // Download as text file
            const blob = new Blob([summary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax-summary-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialize
        updateUI();
        updateMileageUI();
        loadSettings();
        initTheme();
        
        // Auth check on load
        checkAuth();
        
        // ===== RECEIPT SCANNER FUNCTIONS =====
        
        function openReceiptScanner() {
            // Create scanner modal if it doesn't exist
            if (!document.getElementById('scanner-modal')) {
                const scannerHTML = `
                <div id="scanner-modal" class="screen" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-dark);z-index:1000;overflow-y:auto;">
                    <div class="header" style="background:var(--primary);">
                        <div class="back-header">
                            <button class="back-btn" onclick="closeReceiptScanner()" style="background:var(--cta);border:none;color:white;">âœ•</button>
                            <div class="back-title" style="color:white;">Scan Receipt</div>
                        </div>
                    </div>
                    <div class="main" style="padding-top:80px;">
                        <div class="tile" style="text-align:center;background:var(--card);">
                            <div id="scanner-placeholder" style="padding:40px 20px;background:var(--bg-alt);border-radius:12px;margin-bottom:20px;">
                                <div style="font-size:48px;margin-bottom:16px;">ğŸ“·</div>
                                <h3 style="margin-bottom:8px;color:var(--text);">Take a Photo</h3>
                                <p style="color:var(--text-muted);margin-bottom:20px;">Position receipt in good lighting</p>
                                <input type="file" id="receipt-file" accept="image/*" capture="environment" style="display:none;" onchange="processReceipt(this)">
                                <button class="btn btn-cta" onclick="document.getElementById('receipt-file').click()">
                                    ğŸ“· Take Photo / Upload
                                </button>
                            </div>
                            <div id="scanner-result" style="display:none;">
                                <div id="scanned-image" style="margin-bottom:20px;"></div>
                                <div class="insight-card" style="text-align:left;">
                                    <div class="insight-header">ğŸ“‹ Scanned Data</div>
                                    <div class="insight-text">
                                        <div style="margin-bottom:8px;"><strong>Vendor:</strong> <span id="scan-vendor">-</span></div>
                                        <div style="margin-bottom:8px;"><strong>Amount:</strong> <span id="scan-amount">-</span></div>
                                        <div style="margin-bottom:8px;"><strong>Category:</strong> <span id="scan-category">-</span></div>
                                        <div style="margin-bottom:8px;"><strong>Date:</strong> <span id="scan-date">-</span></div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:12px;margin-top:20px;">
                                    <button class="btn btn-outline" onclick="closeReceiptScanner()">Cancel</button>
                                    <button class="btn btn-success" onclick="applyScannedReceipt()">âœ… Add to Expenses</button>
                                </div>
                            </div>
                            <div id="scanner-loading" style="display:none;padding:40px;text-align:center;">
                                <div class="loading" style="width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--primary);margin:0 auto 20px;"></div>
                                <p style="color:var(--text-secondary);">Processing receipt with OCR...</p>
                                <p id="ocr-status" style="color:var(--text-muted);font-size:14px;margin-top:8px;">Initializing...</p>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                document.body.insertAdjacentHTML('beforeend', scannerHTML);
            }
            document.getElementById('scanner-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeReceiptScanner() {
            document.getElementById('scanner-modal').style.display = 'none';
            document.body.style.overflow = '';
            // Reset scanner state
            document.getElementById('scanner-placeholder').style.display = 'block';
            document.getElementById('scanner-result').style.display = 'none';
            document.getElementById('scanner-loading').style.display = 'none';
        }
        
        function processReceipt(input) {
            const file = input.files[0];
            if (!file) return;
            
            document.getElementById('scanner-placeholder').style.display = 'none';
            document.getElementById('scanner-loading').style.display = 'block';
            document.getElementById('ocr-status').textContent = 'Loading OCR engine...';
            
            // Show preview
            const reader = new FileReader();
            reader.onload = async function(e) {
                document.getElementById('scanned-image').innerHTML = `<img src="${e.target.result}" style="max-width:100%;border-radius:8px;">`;
                
                // Run OCR using Tesseract.js (loaded from CDN)
                try {
                    document.getElementById('ocr-status').textContent = 'Recognizing text...';
                    
                    const { createWorker } = Tesseract;
                    const worker = await createWorker('eng');
                    
                    const { data: { text } } = await worker.recognize(e.target.result);
                    await worker.terminate();
                    
                    document.getElementById('ocr-status').textContent = 'Extracting data...';
                    
                    // Parse the OCR text
                    const parsed = parseReceiptText(text);
                    
                    // Update UI with parsed data
                    document.getElementById('scan-vendor').textContent = parsed.vendor || 'Unknown';
                    document.getElementById('scan-amount').textContent = parsed.amount || '-';
                    document.getElementById('scan-category').textContent = parsed.category || '-';
                    document.getElementById('scan-date').textContent = parsed.date || new Date().toLocaleDateString();
                    
                    // Store scanned data
                    window.scannedReceipt = parsed;
                    
                    // Show results
                    document.getElementById('scanner-loading').style.display = 'none';
                    document.getElementById('scanner-result').style.display = 'block';
                    
                } catch (error) {
                    console.error('OCR Error:', error);
                    document.getElementById('ocr-status').textContent = 'OCR failed, using fallback';
                    
                    // Fall back to manual entry
                    setTimeout(() => {
                        document.getElementById('scanner-loading').style.display = 'none';
                        document.getElementById('scanner-result').style.display = 'block';
                        document.getElementById('scan-vendor').textContent = 'Could not read';
                        document.getElementById('scan-amount').textContent = '-';
                        document.getElementById('scan-category').textContent = '-';
                        document.getElementById('scan-date').textContent = '-';
                    }, 1500);
                }
            };
            reader.readAsDataURL(file);
        }
        
        function parseReceiptText(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            
            // Find amount (look for Â£ symbol or decimal numbers)
            let amount = null;
            const amounts = [];
            const amountRegex = /[Â£$]?\s*([0-9]+(?:,[0-9]{3})*(?:\.[0-9]{2})?)/g;
            let match;
            while ((match = amountRegex.exec(text)) !== null) {
                const val = parseFloat(match[1].replace(/,/g, ''));
                if (val > 0 && val < 10000) {
                    amounts.push(val);
                }
            }
            amount = amounts.length > 0 ? Math.max(...amounts) : null;
            
            // Find vendor (usually first line or recognizable store names)
            const vendorKeywords = [
                'tesco', 'sainsbury', 'asda', 'morrisons', 'co-op', 'cooperative',
                'aldi', 'lidl', 'waitrose', 'marks', 'm&s', 'whole foods',
                'shell', 'bp', 'esso', 'texaco', 'total',
                'amazon', 'ebay', 'argos', 'currys', 'john lewis',
                'b&q', 'homebase', 'wilko', 'ikea', 'screwfix',
                'starbucks', 'costa', 'nero', 'cafe', 'restaurant', 'pub',
                'ubereats', 'deliveroo', 'just eat',
                'trainline', 'national rail', 'ticket',
                'pharmacy', 'boots', 'superdrug',
                'mobile', 'vodafone', 'o2', 'ee', 'three',
                'sky', 'bt', 'virgin'
            ];
            
            let vendor = null;
            for (const line of lines.slice(0, 5)) {
                const lower = line.toLowerCase();
                for (const keyword of vendorKeywords) {
                    if (lower.includes(keyword)) {
                        vendor = line.charAt(0).toUpperCase() + line.slice(1).split(' ').map(w => 
                            w.length > 2 ? w.charAt(0).toUpperCase() + w.slice(1).toLowerCase() : w.toLowerCase()
                        ).join(' ');
                        break;
                    }
                }
                if (vendor) break;
            }
            
            if (!vendor && lines.length > 0) {
                vendor = lines[0].charAt(0).toUpperCase() + lines[0].slice(1);
            }
            
            // Find date
            const datePatterns = [
                /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/,
                /(\d{1,2}\s+(?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s+\d{2,4})/i,
                /((?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s+\d{1,2},?\s+\d{4})/i
            ];
            
            let date = null;
            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    date = match[0];
                    break;
                }
            }
            
            if (!date) {
                date = new Date().toLocaleDateString();
            }
            
            // Categorize based on vendor
            const categoryMap = {
                'tesco': 'meals', 'sainsbury': 'meals', 'asda': 'meals', 'morrisons': 'meals',
                'aldi': 'meals', 'lidl': 'meals', 'waitrose': 'meals', 'co-op': 'meals',
                'marks': 'meals', 'm&s': 'meals', 'whole foods': 'meals',
                'shell': 'travel', 'bp': 'travel', 'esso': 'travel', 'texaco': 'travel', 'total': 'travel',
                'amazon': 'equipment', 'ebay': 'equipment', 'currys': 'equipment', 'john lewis': 'equipment',
                'b&q': 'materials', 'homebase': 'materials', 'wilko': 'materials', 'ikea': 'materials',
                'screwfix': 'materials', 'arg': 'materials',
                'starbucks': 'meals', 'costa': 'meals', 'nero': 'meals', 'cafe': 'meals',
                'restaurant': 'meals', 'pub': 'meals',
                'ubereats': 'meals', 'deliveroo': 'meals', 'just eat': 'meals',
                'trainline': 'travel', 'national rail': 'travel', 'ticket': 'travel',
                'pharmacy': 'office', 'boots': 'office', 'superdrug': 'office',
                'mobile': 'utilities', 'vodafone': 'utilities', 'o2': 'utilities',
                'ee': 'utilities', 'three': 'utilities',
                'sky': 'utilities', 'bt': 'utilities', 'virgin': 'utilities'
            };
            
            let category = 'other';
            if (vendor) {
                const lowerVendor = vendor.toLowerCase();
                for (const [keyword, cat] of Object.entries(categoryMap)) {
                    if (lowerVendor.includes(keyword)) {
                        category = cat;
                        break;
                    }
                }
            }
            
            return {
                vendor: vendor || 'Unknown',
                amount: amount,
                category: category,
                date: date,
                rawText: text
            };
        }
        
        function applyScannedReceipt() {
            if (!window.scannedReceipt) return;
            
            if (window.scannedReceipt.amount) {
                document.getElementById('expense-amount').value = window.scannedReceipt.amount;
            }
            if (window.scannedReceipt.vendor && window.scannedReceipt.vendor !== 'Unknown') {
                document.getElementById('expense-description').value = window.scannedReceipt.vendor;
            }
            
            const categories = document.querySelectorAll('#expense-categories .category-btn');
            categories.forEach(btn => {
                if (btn.dataset.category === window.scannedReceipt.category) {
                    selectCategory(btn, 'expense');
                }
            });
            
            closeReceiptScanner();
            showScreen('expenses');
        }
    </script>
</body>
</html>
